sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/each","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/v4/charts/config"],function(q,e,a,o,c){"use strict";var u={};var b={CHART_QUALIFIER_KEY:"chartAnnotationPath",SELVAR_QUALIFIER_KEY:"selectionAnnotationPath",PREVAR_QUALIFIER_KEY:"presentationAnnotationPath",ERROR_NO_CHART:"Analytic cards require valid \"chartAnnotationPath\" "+"configured in manifest.json",LABEL_KEY:"sap:label",TEXT_KEY:"sap:text",TYPE_KEY:"type"};var f={CONFIG_LOAD_ERROR:"Failed to load config.json. Reason: ",CARD_ERROR:"OVP-AC: Analytic card Error: ",INVALID_CHARTTYPE:"Invalid ChartType given for ",ANNO_REF:"com.sap.vocabularies.UI.v1 annotation.",INVALID_CONFIG:"No valid configuration given for ",CONFIG_JSON:"in config.json",CACHING_ERROR:"no model defined while caching OdataMetaData"};var l=new o("OVP.v4.charts.Utils");function g(C,d){if(!d){return"";}var s=C.getSetting('ovpCardProperties');if(!s){return"";}var S=s.oData;if(!S){return"";}var i=S&&S[d]?S[d]:"";return i===""?"":i.split("#")[1];}u.getAllColumnTexts=function(d){return h("sap:text",d);};u.formDimensionPath=function(d){var r="{"+d+"}";var i=this.getModel('ovpCardProperties').getProperty("/entityType");if(!i){return r;}var m=k(i);if(!m||!m[d]){return r;}var t=m[d];if(t=="Edm.DateTime"){return"{path:'"+d+"', formatter: 'sap.ovp.cards.charts.VizAnnotationManager.returnDateFormat'}";}var p=u.getAllColumnTexts(i);if(!p){return r;}r="{"+(p[d]||d)+"}";return r;};function h(p,d){var m={};var r=d.property;for(var i=0,s=r.length;i<s;i++){if(r[i].hasOwnProperty(p)&&p=="com.sap.vocabularies.Common.v1.Label"){m[r[i].name]=r[i][p].String;}else if(r[i].hasOwnProperty(p)){m[r[i].name]=r[i][p];}else{m[r[i].name]=r[i].name;}}return m;}function j(d){return h("com.sap.vocabularies.Common.v1.Label",d);}function k(d){return h("type",d);}var n={};u.LineChart=(function(){function p(C,w,x){var y=r(C,x).split(",");var z=s(C,w).split(",");var A=[];e(y,function(i,m){A.push(m);});var B=[];e(z,function(i,d){B.push(d);});var D=true;var N=C.getSetting("ovpCardProperties").getProperty("/navigation");if(N=="chartNav"){D=false;}var D=D?false:true;return"{ valueAxis:{  layout: { maxWidth : 0.4 }, title:{   visible:false,   text: '"+A.join(",")+"'  },  label:{   formatString:'axisFormatter'  } }, categoryAxis:{  title:{   visible:false,   text: '"+B.join(",")+"'  },  label:{   formatString:'axisFormatter'  } }, legend: {  isScrollable: false }, title: {  visible: false }, general: { groupData: false }, interaction:{  noninteractiveMode: "+D+",  selectability: {   legendSelection: false,   axisLabelSelection: false,   mode: 'EXCLUSIVE',   plotLassoSelection: false,   plotStdSelection: true  }, zoom:{   enablement: 'disabled'} } }";}p.requiresIContext=true;function r(C,d){var w=C.getSetting('ovpCardProperties').getProperty("/entityType");if(!w){return"";}var x=j(w);var y=[];e(d,function(i,m){y.push(x[m.Measure.PropertyPath]||m.Measure.PropertyPath);});return y.join(",");}r.requiresIContext=true;function s(C,m){var w=C.getSetting('ovpCardProperties').getProperty("/entityType");if(!w){return"";}var x=j(w);var y=[];var z;var A;e(m,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Category"){A=x[d.Dimension.PropertyPath];y.push(A?A:d.Dimension.PropertyPath);}});if(y.length<1){A=x[m[0].Dimension.PropertyPath];y.push(A?A:m[0].Dimension.PropertyPath);}z=g(C,b.CHART_QUALIFIER_KEY);n[z]=y;return y.join(",");}s.requiresIContext=true;function t(C,m){var w=[];var x;var y=C.getSetting('ovpCardProperties').getProperty("/entityType");if(!y){return"";}var z=j(y);var A;e(m,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Series"){A=z[d.Dimension.PropertyPath];w.push(A?A:d.Dimension.PropertyPath);}});x=g(C,b.CHART_QUALIFIER_KEY);w=w.filter(function(d){if(!n[x]){return true;}return d!==n[x][0];});return w.join(",");}t.requiresIContext=true;function v(C,d){return t(C,d)!=="";}v.requiresIContext=true;return{getVizProperties:p,getValueAxisFeed:r,getCategoryAxisFeed:s,getColorFeed:t,testColorFeed:v};})();u.BubbleChart=(function(){function p(C,d,A){var B=s(C,A).split(",");var D=t(C,A).split(",");var E=[];e(B,function(i,m){E.push(m);});var F=[];e(D,function(i,m){F.push(m);});var G=true;var N=C.getSetting("ovpCardProperties").getProperty("/navigation");if(N=="chartNav"){G=false;}var G=G?false:true;return"{ valueAxis:{  layout: { maxWidth : 0.4 }, title:{ visible:true, text: '"+E.join(",")+"'  },  label:{ formatString:'axisFormatter'  } }, valueAxis2:{  title:{ visible:true, text: '"+F.join(",")+"'  },  label:{ formatString:'axisFormatter'  } }, categoryAxis:{  title:{ visible:true  },  label:{ formatString:'axisFormatter'  } }, legend: {  isScrollable: false }, title: {  visible: false }, interaction:{  noninteractiveMode: "+G+",  selectability: { legendSelection: false, axisLabelSelection: false, mode: 'EXCLUSIVE', plotLassoSelection: false, plotStdSelection: true  }, zoom:{   enablement: 'disabled'} } }";}p.requiresIContext=true;function r(C,d){var A;if(!C||!C.getSetting||!(A=C.getSetting('ovpCardProperties'))){return[""];}var B=A.getProperty("/entityType");if(!B){return[""];}var D=j(B);var E=[null,null,null];var F=["Axis1","Axis2","Axis3"];e(d,function(i,m){if(F.indexOf(m.Role.EnumMember.split("/")[1])>-1){if(E[0]===null){E[0]=D[m.Measure.PropertyPath]||m.Measure.PropertyPath;}else if(E[1]===null){E[1]=D[m.Measure.PropertyPath]||m.Measure.PropertyPath;}else if(E[2]==null){E[2]=D[m.Measure.PropertyPath]||m.Measure.PropertyPath;}}});return E;}r.requiresIContext=true;function s(C,m){return r(C,m)[0];}s.requiresIContext=true;function t(C,m){return r(C,m)[1];}t.requiresIContext=true;function v(C,m){return r(C,m)[2];}v.requiresIContext=true;function w(C,m){var A=C.getSetting('ovpCardProperties').getProperty("/entityType");if(!A){return"";}var B=j(A);var D=[];var E;e(m,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Series"){E=B[d.Dimension.PropertyPath];D.push(E?E:d.Dimension.PropertyPath);}});return D.join(",");}w.requiresIContext=true;function x(C,m){var A=C.getSetting('ovpCardProperties').getProperty("/entityType");if(!A){return"";}var B=j(A);var D=[];var E;e(m,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Category"){E=B[d.Dimension.PropertyPath];D.push(E?E:d.Dimension.PropertyPath);}});return D.join(",");}x.requiresIContext=true;function y(C,d){return w(C,d)!=="";}y.requiresIContext=true;function z(C,d){return x(C,d)!=="";}z.requiresIContext=true;return{getVizProperties:p,getMeasurePriorityList:r,getValueAxisFeed:s,getValueAxis2Feed:t,getBubbleWidthFeed:v,getColorFeed:w,getShapeFeed:x,testColorFeed:y,testShapeFeed:z};})();u.validateMeasuresDimensions=function(v,t){var m=null;var d=null;if(!v.getDataset()){l.error("OVP-AC: "+t+" Card Error: No Dataset defined for chart.");return false;}m=v.getDataset().getMeasures();d=v.getDataset().getDimensions();switch(t){case"Bubble":if(m.length!==3||d.length<1||!m[0].getName()||!m[1].getName()||!m[2].getName()||!d[0].getName()){l.error("OVP-AC: Bubble Card Error: Enter exactly 3 measures and at least 1 dimension.");return false;}break;case"Donut":if(m.length!==1||d.length!==1||!m[0].getName()||!d[0].getName()){l.error("OVP-AC: Donut Card Error: Enter exactly 1 measure and 1 dimension.");return false;}break;case"Line":if(m.length<1||d.length<1||!m[0].getName()||!d[0].getName()){l.error("OVP-AC: Line Card Error: Configure at least 1 dimensions and 1 measure.");return false;}break;}return true;};u.getSortAnnotationCollection=function(d,p,i){if(p&&p.SortOrder&&p.SortOrder.Path&&p.SortOrder.Path.indexOf('@')>=0){var s=p.SortOrder.Path.split('@')[1];var A=d.getServiceAnnotations()[i.entityType];return A[s];}return p.SortOrder;};u.oFullConfig=null;u.getConfig=function(C){if(!this.oFullConfig){try{this.oFullConfig=a({},c.getChartsConfiguration());}catch(d){l.error(f.CONFIG_LOAD_ERROR+d);}}if(!C){return this.oFullConfig;}var s;try{s=C.$EnumMember.split("/")[1];}catch(d){l.error(f.CARD_ERROR+f.INVALID_CHARTTYPE+f.ANNO_REF);return{};}if(!this.oFullConfig[s]){l.error(f.INVALID_CONFIG+s+" "+f.CONFIG_JSON);return{};}var r;if((r=this.oFullConfig[s].reference)&&this.oFullConfig[r]){var v=a({},this.oFullConfig[r]);this.oFullConfig[s]=v;}return this.oFullConfig[s];};u.oCachedMetaModel={};u.cacheODataMetadata=function(m){if(!m){l.error(f.CARD_ERROR+f.CACHING_ERROR);return;}var E=this.oCachedMetaModel[m.getId()];if(!E){E={};var M=m.getMetaModel();var d=M&&M.getObject("/");var i,p;e(d,function(r,s){if(r!="$kind"){i=M.getObject("/"+s.$Type);p={};e(i,function(t,P){if(P.$kind&&P.$kind=="Property"){p[t]=P;}});E[r]=p;}});this.oCachedMetaModel[m.getId()]=E;}return E;};u.checkIfDataExistInEvent=function(E){if(E.getSource()&&E.getSource().getCurrentContexts()){var d=E.getSource().getCurrentContexts();for(var i=0;i<d.length;i++){if(typeof d[i]!=='undefined'){return true;}}}return false;};return u;},true);
