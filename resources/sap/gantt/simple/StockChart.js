/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/util/merge","./UtilizationChart","sap/ui/core/Core"],function(m,U,C){"use strict";var S=U.extend("sap.gantt.simple.StockChart",{metadata:{library:"sap.gantt",properties:{showMiddleLine:{type:"boolean",defaultValue:true},relativeMiddleLinePoint:{type:"float",group:"Misc",defaultValue:50},minValue:{type:"float",group:"Misc",defaultValue:0},maxValue:{type:"float",group:"Misc",defaultValue:100}},defaultAggregation:"stockChartDimensions",aggregations:{stockChartDimensions:{type:"sap.gantt.simple.StockChartDimension",group:"Data"}}},renderer:{apiVersion:2}});S.prototype.applySettings=function(s,o){s=s||{};U.prototype.applySettings.call(this,s,o);};S.prototype.renderElement=function(r,e){if(this.getStockChartDimensions().length===0){this._renderEmptyDomRefs(r,true);return;}this._renderEmptyDomRefs(r,false);var x=this.getX(),h=this.getHeight(),y=this.getRowYCenter()-h/2,w=this.getWidth();var p={x:x,y:y,width:w,height:h};this._renderDefsDimensionClipPaths(r,p);this._renderMiddleLine(r,p);this._renderDimensionPaths(r,p);this._renderTooltips(r,p);r.close("g");};S.prototype._renderEmptyDomRefs=function(r,c){r.openStart("g",this);r.class("sapGanttStock");r.openEnd();if(c){r.close("g");}};S.prototype._renderDefsDimensionClipPaths=function(r,p){var d=this.getStockChartDimensions();r.openStart("defs").openEnd();for(var i=0;i<d.length;i++){r.openStart("clipPath",d[i].getId()+"-clipPath");r.openEnd();this.renderDimensionPath(r,d[i],p.y,p.height,null,d,true);r.close("clipPath");}r.close("defs");};S.prototype._createThresholdDefsPath=function(t,d){var T=t.getStockChartPeriods();var D=d.getStockChartPeriods();var c=[];var n={};for(var i=0;i<D.length;i++){var o=D[i];var v=o.getValue();if(v>d.getRelativePoint()&&t.getRelativePoint()>d.getRelativePoint()){this._createIntersectionThresholdPaths(D,T,o,d,c,i,true);}else if(v<d.getRelativePoint()&&t.getRelativePoint()<d.getRelativePoint()){this._createIntersectionThresholdPaths(D,T,o,d,c,i,false);}else if(v==d.getRelativePoint()){var s=o.getFrom();var e=o.getTo();if(D[i-1]&&D[i-1].getTo().getTime()==D[i].getFrom().getTime()){var N=this._getNearestThresholdPeriod(T,D[i].getFrom());if(N){var a=this._getCurrentThr(T,N);if(a&&a.getFrom().getTime()>s.getTime()&&N.getTo().getTime()!=a.getFrom().getTime()){var p=this._createSlantThresholdPath(N,a,D,i);n={from:o.getFrom(),to:o.getFrom(),value:p.y};c.push(n);}}}if(t.getRelativePoint()>0&&D[i-1]&&D[i-1].getValue()>d.getRelativePoint()){this._createSlantPath(i,D,T,s,e,d,o,c,true);}else if(t.getRelativePoint()<0&&D[i-1]&&D[i-1].getValue()<d.getRelativePoint()){this._createSlantPath(i,D,T,s,e,d,o,c,true);}n={from:o.getFrom(),to:o.getTo(),value:o.getValue()};c.push(n);}else{n={from:o.getFrom(),to:o.getTo(),value:d.getRelativePoint()};c.push(n);}}return c;};S.prototype._getNearestThresholdPeriod=function(t,d){var p=t.filter(function(T){return d.getTime()-T.getFrom().getTime()>0;});return p[p.length-1]||null;};S.prototype._getNextThresholdPeriod=function(t,d){var a=t.filter(function(T){return T.getFrom().getTime()-d.getTime()>0;});return a[0]||null;};S.prototype._getFilterThresholdPeriods=function(t,d){return t.filter(function(T,i){T._actualIndex=i;return T.getFrom().getTime()==d.getFrom().getTime()||T.getFrom().getTime()==d.getTo().getTime()||(T.getFrom().getTime()>d.getFrom().getTime()&&T.getFrom().getTime()<d.getTo().getTime());});};S.prototype._getPeriodValue=function(d,t,i){var v;if(i){v=d.getValue()>t.getValue()?t.getValue():d.getValue();}else{v=d.getValue()<t.getValue()?t.getValue():d.getValue();}return v;};S.prototype._createIntersectionThresholdPaths=function(d,t,D,o,c,i,a){var s=D.getFrom();var e=D.getTo();var n;var b={};if(s.getTime()!=e.getTime()){var f=this._getFilterThresholdPeriods(t,D);this._createSlantPath(i,d,t,s,e,o,D,c,false);if(f.length>0){for(var j=0;j<f.length;j++){if(j==0&&f[j].getFrom().getTime()>s.getTime()){n=this._getNearestThresholdPeriod(t,f[j].getFrom());var g=this._getCurrentThr(t,n);if(n.getTo().getTime()===g.getFrom().getTime()){if(n.getTo().getTime()===f[j].getFrom().getTime()){b={from:D.getFrom(),to:f[j].getFrom()};b.value=this._getPeriodValue(D,n,a);}else{var p=this._createSlantThresholdPath(n,f[j],d,i);if(n.getTo().getTime()>s.getTime()){b={from:this.getAxisTime().viewToTime(p.x),to:n.getTo(),value:n.getValue()};}else{b={from:D.getFrom(),to:D.getFrom(),value:n.getValue()<o.getRelativePoint()?-p.y:p.y};}}c.push(b);}}if(f[j].getFrom().getTime()==s.getTime()){if(i!=0){if(f[j].getTo().getTime()>D.getTo().getTime()){b={from:D.getFrom(),to:D.getTo()};b.value=this._getPeriodValue(D,f[j],a);}else{b={from:D.getFrom(),to:f[j].getTo()};b.value=this._getPeriodValue(D,f[j],a);}}else{b={from:D.getFrom(),to:D.getTo()};b.value=this._getPeriodValue(D,f[j],a);}c.push(b);}else if(f[j].getFrom().getTime()>s.getTime()){n=this._getNearestThresholdPeriod(t,f[j].getFrom());if(n.getTo().getTime()<s.getTime()){var p=this._createSlantThresholdPath(n,f[j],d,i);var h=this.getAxisTime().viewToTime(p.x);b={value:p.y};b.from=h;b.to=h;c.push(b);}if(f[j].getTo().getTime()>D.getTo().getTime()){b={from:f[j].getFrom(),to:D.getTo()};if(D.getValue()>f[j].getValue()&&d[i+1]&&d[i+1].getValue()>f[j].getValue()){b.to=f[j].getTo();}if(d[i-1]&&s.getTime()!=d[i-1].getTo().getTime()&&n.getValue()<f[j].getValue()&&n.getTo().getTime()!=f[j].getFrom().getTime()){b.from=s;}}else{b={from:f[j].getFrom(),to:f[j].getTo()};}b.value=this._getPeriodValue(D,f[j],a);c.push(b);}}}else{if(!d[i-1]||(s.getTime()==d[i-1].getTo().getTime())){n=this._getNearestThresholdPeriod(t,D.getFrom());var N=this._getNextThresholdPeriod(t,D.getFrom());if(n.getTo().getTime()<D.getFrom().getTime()&&N&&N.getFrom().getTime()>D.getTo().getTime()){var p=this._createSlantThresholdPath(n,N,d,i);var h=this.getAxisTime().viewToTime(p.x);b={value:p.y};b.from=D.getFrom();b.to=D.getFrom();c.push(b);var p=this._createSlantThresholdPath(N,n,d,i);var h=this.getAxisTime().viewToTime(p.x);b={value:p.y};b.from=D.getTo();b.to=D.getTo();c.push(b);}else{if(D.getFrom().getTime()>n.getFrom().getTime()){if(n.getTo().getTime()>D.getTo().getTime()){b={from:D.getFrom(),to:D.getTo()};b.value=this._getPeriodValue(D,n,a);}else if(n.getTo().getTime()>D.getFrom().getTime()){b={from:D.getFrom(),to:n.getTo()};b.value=this._getPeriodValue(D,n,a);}}c.push(b);}}}}};S.prototype._createSlantThresholdPath=function(n,c,d,i){var p=n.getTo().getTime();var P=c.getFrom().getTime();var a=this.getAxisTime().timeToView(p);var b=this.getAxisTime().timeToView(P);var e=n.getValue();var f=c.getValue();var D=this.getAxisTime().timeToView(d[i].getTo().getTime());var x=d[i+1]?this.getAxisTime().timeToView(d[i+1].getFrom().getTime()):D;if(d[i].getFrom().getTime()>n.getTo().getTime()&&d[i].getFrom().getTime()<c.getFrom().getTime()){D=this.getAxisTime().timeToView(d[i].getFrom().getTime());x=d[i-1]?this.getAxisTime().timeToView(d[i-1].getTo().getTime()):D;}var g={x:a,y:e};var h={x:b,y:f};var j={x:D,y:f};var k={x:x,y:e};return this._getIntersect(g,h,j,k);};S.prototype._getIntersect=function(a,b,c,e){var f=(a.x-b.x)*(c.y-e.y);var g=(a.y-b.y)*(c.x-e.x);var d=(f)-(g);if(d==0){throw new Error('Number of intersection points is zero or infinity.');}var u=(a.x*b.y-a.y*b.x);var h=(c.x*e.y-c.y*e.x);var i=c.x-e.x;var j=a.x-b.x;var k=c.y-e.y;var l=a.y-b.y;var n=(u*i-j*h)/d;var o=(u*k-l*h)/d;var p={x:n,y:o};return p;};S.prototype._getCurrentThr=function(t,n){var c,d=Number.MAX_SAFE_INTEGER/2;t.forEach(function(i){if(n.getFrom().getTime()!=i.getFrom().getTime()&&n.getTo().getTime()!=i.getTo().getTime()){var a=Math.abs(i.getFrom().getTime()-n.getTo().getTime());if(a<d){d=a;c=i;}}});return c;};S.prototype._createSlantPath=function(i,d,t,s,e,D,o,c,a){if(d[i-1]&&(s.getTime()!=d[i-1].getTo().getTime())){var n=this._getNearestThresholdPeriod(t,s);var b=this._getCurrentThr(t,n);var p=d[i-1].getTo();var P=this.getAxisTime().timeToView(p);var f={x:P,y:d[i-1].getValue()};var g={x:this.getAxisTime().timeToView(d[i].getFrom().getTime()),y:d[i].getValue()};var h,j;if(n.getTo().getTime()>s.getTime()){h={x:this.getAxisTime().timeToView(d[i-1].getTo().getTime()),y:n.getValue()};j={x:this.getAxisTime().timeToView(n.getTo().getTime()),y:n.getValue()};}else{h={x:this.getAxisTime().timeToView(n.getTo().getTime()),y:n.getValue()};j={x:this.getAxisTime().timeToView(b.getFrom().getTime()),y:b.getValue()};}var k=this._getIntersect(f,g,h,j);var l=this.getAxisTime().viewToTime(k.x);var q={value:k.y};q.from=l;q.to=l;c.push(q);}};S.prototype._renderMiddleLine=function(r,p){if(this.getShowMiddleLine()){var M=this._getMiddleLineY(p);r.openStart("path",this.getId()+"-middleLine");r.attr("d","M "+p.x+" "+M+" h "+p.width);r.class("sapGanttStockMiddleLine");r.openEnd().close("path");}};S.prototype._getMiddleLineY=function(p){var r=this._createTransform(this.getRelativeMiddleLinePoint());var R=p.height*(r/(100));var y=(p.y+p.height)-R;return y;};S.prototype._getClipPathIdOfDimension=function(d){return"url(#"+d.getId()+"-clipPath)";};S.prototype._renderDimensionPaths=function(r,p){var x=p.x,y=p.y,w=p.width,h=p.height;var n=[];var P=[];var a={};var f;var d=this.getStockChartDimensions();var M=d.filter(function(D){return D.getIsThreshold()!=true;});var b=d.filter(function(D){return D.getIsThreshold()==true&&D.getRelativePoint()>M[0].getRelativePoint();}).sort(function(q,s){return s.getRelativePoint()-q.getRelativePoint();});var N=d.filter(function(D){return D.getIsThreshold()==true&&D.getRelativePoint()<M[0].getRelativePoint();}).sort(function(q,s){return q.getRelativePoint()-s.getRelativePoint();});if(M){r.openStart("g").openEnd();var D=M[0];this.renderDimensionPath(r,D,y,h,"scPath");n=[];P=[];for(var i=0;i<D.getStockChartPeriods().length;i++){var o=D.getStockChartPeriods()[i];if(o.getValue()<D.getRelativePoint()){n.push(o);}else{P.push(o);}}var c=h;if(n.length>0&&P.length>0){for(var e=0;e<2;e++){var R=this._createTransform(D.getRelativePoint());var g=h*(R/(100));var j=c-g;if(e==1){if(N.length>0){f=N[0].getRemainCapacityColor();}else{f=D.getRemainCapacityColorNegative();}}else{if(b.length>0){f=b[0].getRemainCapacityColor();}else{f=D.getRemainCapacityColor();}}a={id:D.getId()+(e==1?"-scRectNegative":"-scRect"),x:x,y:(e==1?(y+j):y),width:w,height:(e==1?h-j:h-(h-j)),fill:f,"clip-path":this._getClipPathIdOfDimension(D)};this.renderRectangleWithAttributes(r,a);}}else if(P.length>0||n.length>0){var t=P.length>0?b:n;if(t.length>0){f=t[0].getRemainCapacityColor();}else{f=D.getRemainCapacityColor();}a={id:D.getId()+(P.length>0?"-scRect":"-scRectNegative"),x:x,y:y,width:w,height:h,fill:f,"clip-path":this._getClipPathIdOfDimension(D)};this.renderRectangleWithAttributes(r,a);}r.close("g");}if(b.length>0){for(var I=0;I<b.length;I++){r.openStart("g").openEnd();var k=b[I];this.renderDimensionPath(r,k,y,h,"scPath");a={id:k.getId()+"-scRect",x:x,y:y,width:w,height:h,fill:b[I+1]?b[I+1].getRemainCapacityColor():M[0].getRemainCapacityColor(),"clip-path":this._getClipPathIdOfDimension(k)};this.renderRectangleWithAttributes(r,a);r.close("g");}}if(N.length>0){for(var I=0;I<N.length;I++){r.openStart("g").openEnd();var l=N[I];this.renderDimensionPath(r,l,y,h,"scPath");a={id:l.getId()+"-scRect",x:x,y:y,width:w,height:h,fill:N[I+1]?N[I+1].getRemainCapacityColor():M[0].getRemainCapacityColor(),"clip-path":this._getClipPathIdOfDimension(l)};this.renderRectangleWithAttributes(r,a);r.close("g");}}};S.prototype._renderTooltips=function(r,p){var y=p.y,h=p.height;r.openStart("g");r.class("sc-tooltips").openEnd();var d=this.getAllDimensionPoints();d.forEach(function(P,i,a){var n=a[i+1]||P;var t=P.tooltip;var D=P.name!==n.name;if(D){t=P.tooltip+"\n"+n.tooltip;}var x=this.toX(P.from),l=a.length-1===i,X=this.toX(l?n.to:n.from),w=Math.abs(X-x);if(w>0){var b={opacity:0,fillOpacity:0,strokeOpacity:0};var A=m({x:x,y:y,width:w,height:h},b);this.renderRectangleWithAttributes(r,A,t);}}.bind(this));r.close("g");};S.prototype.getAllDimensionPoints=function(){var A=[];this.getStockChartDimensions().forEach(function(d){var n=d.getName();d.getStockChartPeriods().forEach(function(p,i,P){var t=p.getTooltip();if(!t){t=n+":"+p.getValue();}if(p.getFrom()!=p.getTo()){A.push({name:n,from:p.getFrom(),to:p.getFrom(),tooltip:t});A.push({name:n,from:p.getTo(),to:p.getTo(),tooltip:t});}else{A.push({name:n,from:p.getFrom(),to:p.getTo(),tooltip:t});}});});A.sort(function(a,b){return a.from-b.from;});return A;};S.prototype.renderDimensionPath=function(r,D,R,a,I,b,c){if(D.getIsThreshold()&&c){var M=b.filter(function(D){return D.getIsThreshold()!=true;});var e=this._createThresholdDefsPath(D,M[0]);}var p=D.getIsThreshold()&&c?e:D.getStockChartPeriods();var d="";for(var i=0;i<p.length;i++){var f=(i===0),l=(i===p.length-1);var P=p[i];var x=this.toX(D.getIsThreshold()&&c?P.from:P.getFrom());var g=this.toX(D.getIsThreshold()&&c?P.to:P.getTo());var v=D.getIsThreshold()&&c?P.value:P.getValue();if(v>(100)){v=100;}if(v<this.getMinValue()){v=this.getMinValue();}var y=R+a;var h=a*(this._createTransform(v)/(100));var j=y-h;var k=this._createTransform(D.getIsThreshold()&&c?M[0].getRelativePoint():D.getRelativePoint());var n=a*(k/(100));var o=y-n;d+=(f?" M "+x+" "+o:"")+" L "+x+" "+j+" L "+g+" "+j+(l?" L "+g+" "+o:"");}if(I){r.openStart("path",D.getId()+"-"+I);}else{r.openStart("path");}r.attr("d",d);r.attr("fill","none");r.attr("stroke-width",D.getDimensionStrokeWidth());if(D.getDimensionStrokeDasharray()){r.attr("stroke-Dasharray",D.getDimensionStrokeDasharray());}r.attr("stroke",D.getDimensionPathColor());r.class("sapGanttScDimensionPath");r.openEnd().close("path");};S.prototype._createTransform=function(v){var o={max:this.getMaxValue(),min:this.getMinValue()};var n={max:100,min:0};var s=(n.max-n.min)/(o.max-o.min);var a=(v-o.min)*s;return a;};S.prototype.destroy=function(){U.prototype.destroy.apply(this,arguments);};return S;},true);
